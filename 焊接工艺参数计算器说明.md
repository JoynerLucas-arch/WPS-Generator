# 焊接工艺参数计算器 (WPSCalculator)

## 概述

焊接工艺参数计算器是一个专门用于根据母材厚度自动计算焊接工艺参数的模块。该模块集成到现有的焊接工艺规程生成系统中，能够在Excel数据解析后自动计算出相应的焊接参数，并将完整的数据发送给大模型进行文档生成。

## 功能特性

### 1. 自动厚度识别
- 从Excel解析的材质信息中自动提取厚度值
- 支持格式：`"3mm 6005A-T6"` → 提取厚度 `3mm`
- 自动选择两个材质厚度的较小值作为参考厚度

### 2. 分层参数配置
根据参考厚度自动选择对应的参数范围：

#### 0-3mm板厚
- 电流强度：160A ~ 180A
- 电弧电压：22V ~ 23.2V
- 送丝速度：10.1m/min ~ 11.6m/min
- 参考热输入：0.18KJ/mm

#### 3-5mm板厚
- 电流强度：180A ~ 200A
- 电弧电压：23.2V ~ 23.5V
- 送丝速度：11.6m/min ~ 12.7m/min
- 参考热输入：0.42KJ/mm

#### 5mm以上板厚
- 电流强度：200A ~ 220A
- 电弧电压：23.5V ~ 23.8V
- 送丝速度：12.7m/min ~ 13.8m/min
- 参考热输入：0.43KJ/mm

### 3. 自动参数计算

#### 焊接速度计算
- **焊接速度小** = (0.8 × 电流强度大 × 电弧电压大 × 0.001) ÷ (参考热输入 × 1.25) [向上取整]
- **焊接速度大** = (0.8 × 电流强度小 × 电弧电压小 × 0.001) ÷ (参考热输入 × 0.75) [向下取整]

#### 热输入计算
- **热输入小** = (0.8 × 电流强度小 × 电弧电压小 × 0.001) ÷ 焊接速度大 [保留两位小数]
- **热输入大** = (0.8 × 电流强度大 × 电弧电压大 × 0.001) ÷ 焊接速度小 [保留两位小数]

## 文件结构

```
├── wps_calculator.py          # 主要计算器类


└── 焊接工艺参数计算器说明.md   # 本说明文档
```

## 核心类和方法

### WPSCalculator 类

#### 主要方法

1. **`extract_thickness_from_material(material_str)`**
   - 从材质字符串中提取厚度值
   - 输入：`"3mm 6005A-T6"`
   - 输出：`3.0`

2. **`get_min_thickness(t1_material, t2_material)`**
   - 获取两个材质厚度的较小值
   - 用于确定参考厚度

3. **`calculate_welding_parameters(excel_data)`**
   - 核心计算方法
   - 根据Excel数据计算所有焊接工艺参数

4. **`process_excel_data(excel_data)`**
   - 主要处理方法
   - 整合原始数据和计算参数

5. **`format_parameters_for_display(calculated_params)`**
   - 格式化参数用于显示
   - 生成易读的参数说明

## 集成方式

### 在 DeepSeekClient 中的集成

```python
class DeepSeekClient:
    def __init__(self, api_key: str, base_url: str = "https://api.deepseek.com"):
        # ... 其他初始化代码
        self.wps_calculator = WPSCalculator()  # 初始化计算器
    
    def chat(self, message: str, excel_data: Optional[Dict[str, Any]] = None, stream: bool = False) -> str:
        if excel_data:
            # 使用计算器处理Excel数据
            processed_data = self.wps_calculator.process_excel_data(excel_data)
            # 发送处理后的数据给大模型
```

### 数据流程

1. **Excel解析** → ExcelParser 解析Excel文件
2. **参数计算** → WPSCalculator 计算焊接工艺参数
3. **数据合并** → 原始数据 + 计算参数
4. **发送大模型** → DeepSeekClient 发送完整数据
5. **文档生成** → 大模型生成焊接工艺规程

## 使用示例

### 在GUI中的使用

GUI会自动调用计算器，用户只需：
1. 上传Excel文件
2. 系统自动解析和计算
3. 发送消息给大模型
4. 生成焊接工艺规程

## 输出参数

计算器会输出以下10个关键参数：

1. **电流强度小** - 最小电流强度值
2. **电流强度大** - 最大电流强度值
3. **电弧电压小** - 最小电弧电压值
4. **电弧电压大** - 最大电弧电压值
5. **送丝速度小** - 最小送丝速度值
6. **送丝速度大** - 最大送丝速度值
7. **焊接速度小** - 计算得出的最小焊接速度
8. **焊接速度大** - 计算得出的最大焊接速度
9. **热输入小** - 计算得出的最小热输入
10. **热输入大** - 计算得出的最大热输入

## 测试和验证

### 运行测试

```bash

```

### 测试用例

测试脚本包含三个不同厚度范围的测试用例：
- 薄板测试 (0-3mm)
- 中厚板测试 (3-5mm) 
- 厚板测试 (5mm+)

## 错误处理

- **厚度提取失败**：返回原始Excel数据，不进行计算
- **计算异常**：捕获异常并记录，返回原始数据
- **数据格式错误**：提供详细的错误信息

## 扩展性

### 添加新的厚度范围

在 `WPSCalculator.__init__()` 中的 `thickness_ranges` 字典中添加新的配置：

```python
self.thickness_ranges = {
    # 现有配置...
    "10mm+": {
        "current_min": 250,
        "current_max": 300,
        # ... 其他参数
    }
}
```

### 修改计算公式

在 `calculate_welding_parameters()` 方法中修改相应的计算逻辑。

## 注意事项

1. **厚度单位**：系统假设厚度单位为毫米(mm)
2. **材质格式**：材质字符串应遵循 `"厚度mm 材质代码"` 格式
3. **参数精度**：热输入保留两位小数，焊接速度为整数
4. **异常处理**：计算失败时会回退到原始数据，确保系统稳定性

## 更新日志

### v1.0.0 (当前版本)
- 实现基础的厚度识别和参数计算功能
- 集成到DeepSeekClient中
- 提供完整的测试和演示脚本
- 支持三个厚度范围的参数配置

---